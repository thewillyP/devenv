@Library('singularity_template@main') _

properties([
    parameters([
        booleanParam(name: 'forceRebuild', defaultValue: false, description: 'Force rebuild of the Singularity image'),
        string(name: 'buildTime', defaultValue: '00:30:00', description: 'Build job time limit'),
        string(name: 'buildCPUs', defaultValue: '8', description: 'CPUs to allocate for build'),
        string(name: 'buildMem', defaultValue: '10G', description: 'Memory to allocate for build'),
        string(name: 'runTime', defaultValue: '06:00:00', description: 'Run job time limit'),
        string(name: 'runCPUs', defaultValue: '4', description: 'CPUs to allocate for run'),
        string(name: 'runMem', defaultValue: '14G', description: 'Memory to allocate for run'),
        string(name: 'binds', defaultValue: '/home/wlp9800/.awsvault,/home/wlp9800/.gnupg,/home/wlp9800/dev,/scratch/wlp9800/wandb:/wandb_data,/scratch/wlp9800/space:/scratch', description: 'Bind paths for Singularity'),
        booleanParam(name: 'useGpu', defaultValue: false, description: 'Use GPU in the Singularity container'),
        booleanParam(name: 'exclusive', defaultValue: false, description: 'Run with exclusive node access'),
        string(name: 'proxyjump', defaultValue: 'greene', description: 'Proxyjump server for SSH access'),
        string(name: 'localForwards', defaultValue: '', description: 'Comma-separated list of LocalForward rules (e.g., "8888:localhost:8245,9999:localhost:9000")'),
        string(name: 'execHost', defaultValue: 'greene', description: 'Execution host for SSH commands')
    ])
])

def defaults = [
    sshUser: 'wlp9800',
    image: 'devenv-cpu',
    scratchDir: '/scratch/wlp9800',
    logDir: '/vast/wlp9800/logs',
    dockerUrl: 'docker://thewillyp/devenv:cpu',
    overlaySrc: '/scratch/work/public/overlay-fs-ext3/overlay-25GB-500K.ext3.gz',
    entrypointUrl: 'https://raw.githubusercontent.com/thewillyP/devenv/master/entrypoint.sh',
    forceRebuild: params.forceRebuild,
    buildTime: params.buildTime,
    buildCPUs: params.buildCPUs,
    buildMem: params.buildMem,
    runTime: params.runTime,
    runCPUs: params.runCPUs,
    runMem: params.runMem,
    binds: params.binds,
    useGpu: params.useGpu,
    exclusive: params.exclusive,
    proxyjump: params.proxyjump,
    localForwards: params.localForwards,
    execHost: params.execHost
]

pipeline {
    agent any

    stages {
        stage('Checkout Scripts') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: 'https://github.com/thewillyP/jenkins.git']]
                ])
            }
        }

        stage('Run Singularity Pipeline') {
            steps {
                script {
                    def runJobId = singularityPipeline(defaults)
                    echo "Singularity run job id: ${runJobId}"
                    env.RUN_JOB_ID = runJobId
                }
            }
        }

        stage('Submit Service Registration Job') {
            steps {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-credentials',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    script {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${defaults.sshUser}@${defaults.execHost} '
                                export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}";
                                export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}";
                                bash -s "${env.RUN_JOB_ID}" "${defaults.image}" "${defaults.logDir}" "1G" "00:05:00" "1" "${defaults.proxyjump}" "2001" "${defaults.localForwards}"
                            ' < register_service.sh
                        """
                    }
                }
            }
        }
    }
}
