@Library('singularity_template@main') _
def defaults = [
    sshUser: 'wlp9800',
    image: 'devenv-cpu',
    scratchDir: '/scratch/wlp9800',
    logDir: '/vast/wlp9800/logs',
    dockerUrl: 'docker://thewillyp/devenv-cpu',
    forceRebuild: false,
    overlaySrc: '/scratch/work/public/overlay-fs-ext3/overlay-25GB-500K.ext3.gz',
    buildTime: '00:30:00',
    buildCPUs: '8',
    buildMem: '10G',
    runTime: '06:00:00',
    runCPUs: '4',
    runMem: '14G',
    entrypointUrl: 'https://raw.githubusercontent.com/thewillyP/devenv/master/entrypoint.sh',
    binds: "/home/wlp9800/dev,/scratch/wlp9800/wandb:/wandb_data,/scratch/wlp9800/space:/scratch",
    useGpu: false 
]

pipeline {
    agent any

    stages {
        stage('Run Singularity Pipeline') {
            steps {
                script {
                    def runJobId = singularityPipeline(defaults)
                    echo "Singularity run job id: ${runJobId}"
                    env.RUN_JOB_ID = runJobId
                }
            }
        }

        stage('Submit DNS Update Job') {
            steps {
                script {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${defaults.sshUser}@${env.EXEC_HOST} \\
                      'curl -fsSL https://raw.githubusercontent.com/thewillyP/jenkins/main/submit_dns_job.sh | \\
                      bash -s ${env.RUN_JOB_ID} ${defaults.image} ${defaults.logDir} dns-update-${defaults.image} 1G 00:05:00 1 ${defaults.sshUser}'
                    """
                }
            }
        }
    }
}
